
# a little macro to let you test other gcode macros and or evaluate jinja.

[gcode_macro DEBUG_OUTPUT]
description: "Render a gcode_macro (no execution) OR evaluate ad-hoc Jinja, with per-key captured output blocks."
gcode:
    {% set SELF  = 'DEBUG_OUTPUT' %}
    {% set name  = params.MACRO|default('', true) %}
    {% set gm    = printer.printer.lookup_object('gcode_macro') %}
    {% set gcode = printer.printer.lookup_object('gcode') %}
    {% set exec  = params.EXEC|default(0, true)|int %}

    {% set kept, execs, sinkbuf = [], [], [] %}
    {% macro sink(m='') %}{% set _ = sinkbuf.append(m|string) %}{% endmacro %}
    {% macro install(ctx) %}
        {%- set _ = ctx.update({
            'action_respond_info': sink,
            'action_raise_error':  sink,
            'action_call_remote_method': sink,
        }) -%}
    {% endmacro %}

    {% macro print_results(content, header) %}
        {% set head = "<b>" ~ SELF ~ "</b> " ~ header ~ "<br>" %}
        {% set body = "
        <div style='
            display:inline-block;
            background-color:rgba(0,0,0,0.35);
            border:1px solid rgba(255,255,255,0.18);
            border-radius:4px;
            padding:4px;
            overflow:auto;
            font-size:75%;
            max-width:90%;
            width:max-content;
            box-sizing:border-box;
            white-space:normal;'>      
            <pre style='
                margin:4px;
                white-space:pre-wrap;
                line-height:135%;
                overflow:auto;'>" ~
                content|replace('\n', '<br>') ~
            "</pre>
        </div>" %}
        { action_respond_info( (head ~ body)|replace('\n', '') ) }
    {% endmacro %}


    {% if name %}
        {% set obj = printer.printer.lookup_object('gcode_macro ' ~ name, None) %}
        {% if obj is none %}
            { action_respond_info(SELF ~ ": unknown macro '" ~ name ~ "'") }
        {% else %}
            {% set ctx = obj.template.create_template_context() %}
            {% set _ = ctx.update(obj.variables) %}

            {% set fwd = {} %}
            {% for k, v in params.items() if k != 'MACRO' and k != 'EXEC' %}
                {% set _ = fwd.update({k: v}) %}
            {% endfor %}
            {% set _ = ctx.update({'params': fwd}) %}

            { install(ctx) }

            {% set rendered = obj.template.render(ctx)|replace('\r', '') %}

            {% for line in rendered.split('\n') %}
                {% set t = line|trim %}
                {% if t %}
                    {% set _ = kept.append(line) %}
                    {% if t.startswith('SET_GCODE_VARIABLE ') or t == 'M400' %}
                        {% set _ = execs.append(t) %}
                    {% endif %}
                {% endif %}
            {% endfor %}


            { print_results(content=(kept|join('\n')|e), header=name|e ) }

            {% for m in sinkbuf %}
                {% set t = m|string %}
                {% if ('|' ~ name) in t and ('|DEBUG_OUTPUT MACRO=' ~ name) not in t %}
                    {% set t = t|replace('|' ~ name ~ ' ', '|DEBUG_OUTPUT MACRO=' ~ name ~ ' ') %}
                    {% set t = t|replace('|' ~ name ~ '|', '|DEBUG_OUTPUT MACRO=' ~ name ~ '|') %}
                {% endif %}
                { action_respond_info(t) }
            {% endfor %}

            { execs|join('\n') }

        {% endif %}

    {% else %}
        {% if not params %}
            {% set content = SELF ~ " FOO=\"(1|int + 2|int)\"<br>" ~ 
                             SELF ~ " HELLO=\"{ action_respond_info('WORLD') }\"<br>" ~
                             "or: " ~ SELF ~ (" MACRO=SOME_MACRO EXEC=<0|1>...")|e ~ "<br>" ~ 
                             "     to evaluate and test the output of a gcode macro."
            %}
            { print_results(content, 'USAGE:') }
        {% else %}
            {% for key, raw in params.items() if key != 'EXEC' %}
                {% set ctx = gm.create_template_context() %}
                { install(ctx) }

                {% set val = raw %}
                {% if '{' not in val and '}' not in val
                      and not val.startswith('RESPOND')
                      and not val.startswith("{'RESPOND") %}
                    {% set val = ('{action_respond_info((' ~ val ~ ')|string|e)}') %}
                {% endif %}

                {% set rendered = gm.env.from_string(val).render(ctx) %}
                {% set out = sinkbuf|join('\n')|replace('\r','') %}
                {% if not out %}
                    {% set out = rendered|replace('\r','') %}
                {% endif %}

                { print_results(content=out|e, header=key|e ) }

                {% if exec and rendered %}
                    {% set _ = gcode.run_script_from_command(rendered) %}
                {% endif %}
            {% endfor %}
        {% endif %}
    {% endif %}
