[gcode_macro DOC_DUMP]
variable_splitter_key:  '§'
description:            "Usage: DOC_DUMP S=foo§bar   (§ = AND, case-insensitive)"
variable_color_obj:     "rgb(0,150,255)"
variable_color_meth:    "rgb(255,200,50)"
variable_color_doc:     "rgb(180,180,180)"
variable_color_match:   "rgb(255,0,100)"
variable_color_section: "rgb(200,180,255)"
variable_color_kind:    "rgb(120,220,200)"
gcode:
    {% set query     = params.S|default("")|string %}
    {% set terms     = query.lower().split(splitter_key) %}
    {% set include__ = params.DUNDER|default(False) %}
    {% set skipdocs  = (query == "") %}

    {% set types = [
        ['string',     ''],
        ['list',       []],
        ['dictionary', {}],
        ['tuple',      ()],
        ['int',        0|int],
        ['float',      0.0],
        ['self',       self],
        ['generator',  {}|select]
    ] %}

    {% set sections = [] %}
    {% set section_meta = [
        ['string',     'string methods'],
        ['list',       'list methods'],
        ['dictionary', 'dict methods'],
        ['tuple',      'tuple methods'],
        ['int',        'int methods'],
        ['float',      'float methods'],
        ['self',       'template / self'],
        ['generator',  'generator helpers'],
        ['filter',     'filters'],
        ['test',       'tests'],
        ['global',     'globals']
    ] %}

    {% set data = {} %}
    {% for typ, obj in types %}{% set _ = data.update({typ: []}) %}{% endfor %}
    {% set _ = data.update({
        'filter': [],
        'test':   [],
        'global': []
    }) %}

    {% macro main() %}
        # ──────────────────────────────────────────────────────────────
        # 1) Introspect methods on sample types (string/list/dict/etc.)
        {% for typ, obj in types %}
            {% for meth in obj.__dir__() %}
                {% if not (meth.startswith('__') and meth.endswith('__')) or include__ %}
                    {% set fn = obj|attr(meth) %}
                    {% set _data = _add_type_method(typ, meth, fn, terms) %}
                    {% set _ = data[typ].append(_data) if _data %}
                {% endif %}
            {% endfor %}
        {% endfor %}

        # ──────────────────────────────────────────────────────────────
        # 2) Introspect filters / tests / globals from Jinja environment
        {%- set ctx = self._TemplateReference__context or {}  -%}
        {%- set filters = ctx.environment.filters or {} -%}
        {%- set tests   = ctx.environment.tests   or {} -%}
        {%- set globals = ctx.environment.globals or {} -%}

        {% for fname, fn in filters.items() %}  { _add_env_entry('filter', 'filter', fname, fn, terms) }  {% endfor %}
        {% for tname, tfn in tests.items() %}   { _add_env_entry('test', 'test', tname, tfn, terms) }     {% endfor %}
        {% for gname, gval in globals.items() %}{ _add_env_entry('global', 'global', gname, gval, terms) }{% endfor %}

        # ──────────────────────────────────────────────────────────────
        # 3) Assemble sections and print with action_respond_info
        {% set total = (data.values()|sum(start=[]))|length %}
        {% if total == 0 %}
            { action_respond_info("DOC_DUMP: no doc matches found for '" ~ query|e ~ "'") }
        {% else %}
            {% for key, label in section_meta %}
                {% if data[key] %}
                    {% set content = data[key]|join('') %}
                    {% set summary = _span(color_section, label ~ " (" ~ data[key]|length|string ~ ")") %}
                    {% set _ = sections.append(_details(summary, content)) %}
                {% endif %}
            {% endfor %}

            {% set title = "<b>DOC_DUMP: found " ~ total ~ " matches for '" ~ query|e ~ "'</b>" %}
            {% set report = _details(title, sections|join('')) %}
            { action_respond_info("<div style='font-size:0.8em; line-height:1.4;'>" ~ report ~ "</div>") }
        {% endif %}

    {%- endmacro %}

    # small HTML helpers, aligned with INSPECT_OBJECT
    {%- macro _span(color, txt) -%}
        { "<span style='color:" ~ color ~ "'>" ~ txt ~ "</span>" }
    {%- endmacro -%}

    {%- macro _details(summary, content) -%}
        { "<details><summary style='cursor:pointer;'>" ~ 
            summary ~ "</summary><div style='padding-left: 20px; border-left: 1px solid rgb(51, 51, 51);'>" ~ 
            content ~ "</div></details>" }
    {%- endmacro -%}

    {%- macro highlight(text, term) -%}
        {%- set L   = term|length -%}
        {%- set low = text.lower() -%}
        {%- set idx = low.find(term) -%}
        {%- set out = text[:idx] ~ "<span style='color:" ~ color_match ~ "'>" ~ 
                     text[idx:idx+L] ~ "</span>" ~ text[idx+L:] if idx != -1 else text -%}
        { out }
    {%- endmacro -%}

    {%- macro format_doc(text) -%}
        {%- set parts      = text.split('\n\n') -%}
        {%- set paragraphs = [] -%}
        {%- for p in parts -%}
            {%- set _ = paragraphs.append(p|replace('\n', ' ')|trim) -%}
        {%- endfor -%}
        { paragraphs|join('<br>') }
    {%- endmacro -%}

    # ──────────────────────────────────────────────────────────────
    # macro: add one method entry for a given example type
    {%- macro _add_type_method(typ, meth, fn, search_terms) -%}
        {%- if fn and (fn.__doc__ or skipdocs) -%}
            {%- set search_docs = fn.__doc__ if not skipdocs else '' -%}
            {%- set haystack    = (typ ~ " " ~ meth ~ " " ~ search_docs)|lower -%}
            {%- set missing     = search_terms|select|reject('in', haystack)|list -%}
            {%- if missing|length == 0 -%}
                {%- set mask = namespace(
                    meth_html = meth,
                    doc_html  = format_doc(search_docs|e)
                ) -%}
                {%- for t in search_terms -%}
                    {%- set mask.meth_html = highlight(mask.meth_html, t) -%}
                    {%- set mask.doc_html  = highlight(mask.doc_html,  t) -%}
                {%- endfor -%}
                {%- set row =
                    "<div style='margin-left:1em; padding: 2px 0;'>"
                        ~ "<div>"
                            ~ _span(color_obj, typ)
                            ~ _span(color_doc, ".")
                            ~ _span(color_meth, mask.meth_html)
                        ~ "</div>"
                        ~ "<div style='margin-left:0.5em; color:" ~ color_doc ~ "; white-space:pre-wrap; font-size:0.75em;'>"
                            ~ mask.doc_html
                        ~ "</div>"
                    ~ "</div>"
                -%}
                { row }
            {%- endif -%}
        {%- endif -%}
    {%- endmacro -%}

    # ──────────────────────────────────────────────────────────────
    # macro: add one env entry (filter/test/global)
    {%- macro _add_env_entry(bucket_key, kind_label, name, val, search_terms) -%}
        {%- set doc_raw     = val.__doc__ if val and val.__doc__ is defined else '' -%}
        {%- set search_docs = doc_raw if not skipdocs else '' -%}
        {%- set haystack    = (kind_label ~ " " ~ name ~ " " ~ search_docs)|lower -%}
        {%- set missing     = search_terms|select|reject('in', haystack)|list -%}
        {%- if missing|length == 0 -%}
            {%- set mask = namespace(
                meth_html = name,
                doc_html  = format_doc(search_docs|e)
            ) -%}
            {%- for t in search_terms -%}
                {%- set mask.meth_html = highlight(mask.meth_html, t) -%}
                {%- set mask.doc_html  = highlight(mask.doc_html,  t) -%}
            {%- endfor -%}
            {%- set row =
                "<div style='margin-left:1em; padding: 2px 0;'>"
                    ~ "<div>"
                        ~ _span(color_kind, kind_label)
                        ~ _span(color_doc, ".")
                        ~ _span(color_meth, mask.meth_html)
                    ~ "</div>"
                    ~ "<div style='margin-left:0.5em; color:" ~ color_doc ~ "; white-space:pre-wrap; font-size:0.75em;'>"
                        ~ mask.doc_html
                    ~ "</div>"
                ~ "</div>"
            -%}
            {%- set _ = data[bucket_key].append(row) -%}
        {%- endif -%}
    {%- endmacro -%}

    { main() }
