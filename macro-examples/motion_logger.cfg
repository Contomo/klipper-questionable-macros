[gcode_macro MOTION_LOGGER]
description: "Start/stop motan data_logger and show a toolhead velocity plot"
variable_verbose: True
variable_settings: {
        'img_dir':      '~/printer_data/config/motion_images',
        'datasets':     '[["trapq(toolhead,velocity)"]]',
        'max_duration': 30,
        'uds':          '~/printer_data/comms/klippy.sock',
        'log_dir':      '/tmp',
        'pidfile':      '/tmp/motion_logger.pid',
        'prefix':       'motan_motion_',
        'python_path':  '',
        'logger_path':  '~/klipper/scripts/motan/data_logger.py',
        'graph_path':   '~/klipper/scripts/motan/motan_graph.py',
        'img_prefix':   'motion_plot_',
        'max_px':       400,
        'open_size_percent': 75,
    }
variable_started_at: -1
gcode:
    # --- Context & Imports ---------------------------------------------------
    {% set SELF              = 'MOTION_LOGGER' %}
    {% set gbl               = printer.printer.__class__.__init__.__globals__ %}
    {% set imp               = gbl.importlib.import_module %}
    {% set os, time, sp, sys = imp('os'), imp('time'), imp('subprocess'), imp('sys') %}
    {% set bi, signal        = imp('builtins'), imp('signal') %}
    {% set expand            = os.path.expanduser %}
    {% set s                 = settings %}

    # --- Debug & UI Helpers --------------------------------------------------
    {%- set _dbg_buf = [] -%}
    {%- macro dbg(s) -%}{%- set _ = _dbg_buf.append('<p>'~s|replace('\n','<br>')~'</p>') if verbose -%}{%- endmacro -%}

    {%- macro msg(s, col="--p-text-color2", pre_col="--v-accent-base") -%}
        {%- set d = (printer.configfile.settings['gcode_macro ' ~ SELF|lower].description|trim).strip('"') -%}
        {%- set p = "<span style=\"color:var("~pre_col~");font-weight:bold;\" title=\""~d~"\">"~SELF~" </span>" -%}
        { action_respond_info(p ~ "<span style=\"color:var("~col~");\" title=\""~d~"\">"~s~"</span>") }
    {%- endmacro -%}
    {%- macro err(s) -%}{ msg(s, col="--v-warning-base", pre_col="--v-error-base") }{%- endmacro -%}


    # --- Core Logic: Start ---------------------------------------------------
    {% macro do_start() %}
        {% set log_dir = expand(s.log_dir) %}
        {% set script  = expand(s.logger_path) %}
        
        {% if not os.path.exists(script) %}
            { err('Logger script not found: ' ~ script) }
        {% else %}
            { _ensure_dir(log_dir) }
            
            {% set log_prefix = os.path.join(
                log_dir, s.prefix ~ time.strftime('%Y-%m-%d_%H-%M-%S')
            ) %}
            {% set py = _resolve_python(s.python_path) %}
            
            {% set cmd = [py, script, expand(s.uds), log_prefix] %}
            { dbg('START: ' ~ cmd|join(' ')) }
            {% set proc = sp.Popen(cmd, stdout=sp.DEVNULL, stderr=sp.DEVNULL) %}
            
            {% set pid_file = expand(s.pidfile) %}
            {% set fh = bi.open(pid_file, 'w') %}
            {% set _  = fh.write(proc.pid ~ '\n' ~ log_prefix) %}
            {% set _  = fh.close() %}

            { msg('Logging started (PID: ' ~ proc.pid ~ ') â†’ ' ~ log_prefix) }
            SET_GCODE_VARIABLE MACRO={SELF} VARIABLE=started_at VALUE={time.time()}
        {% endif %}
    {% endmacro %}


    # --- Core Logic: Stop ----------------------------------------------------
    {% macro do_stop() %}
        {% set pid_file = expand(s.pidfile) %}
        {% set pid_data = _read_pid(pid_file) %}

        {% if not pid_data %}
            { err('No active PID file found at ' ~ pid_file) }
        {% else %}
            {% set pid, log_prefix = pid_data.split('|') %}
            
            { _kill_process(pid_file) }

            {% set graph_script = expand(s.graph_path) %}
            {% if not os.path.exists(graph_script) %}
                { err('Graph script not found: ' ~ graph_script) }
            {% else %}
                {% set img_dir = expand(s.img_dir) %}
                { _ensure_dir(img_dir) }

                {% set out_file = os.path.join(img_dir, s.img_prefix ~ time.strftime('%Y-%m-%d_%H-%M-%S') ~ '.png') %}
                {% set py = _resolve_python(s.python_path) %}

                {% set cmd = [
                    py, graph_script, log_prefix,
                    '-g', s.datasets,
                    '-d', [s.max_duration, time.time() - started_at]|min|string,
                    '-o', out_file
                ] %}
                { dbg('GRAPH: ' ~ cmd|join(' ')) }
                {% set res = sp.run(cmd, stdout=sp.PIPE, stderr=sp.STDOUT) %}
                
                {% if res.returncode != 0 or not os.path.exists(out_file) %}
                    { dbg('Graph Error: ' ~ res.stdout.decode('utf-8','ignore')) }
                    { err('Graph generation failed.') }
                {% else %}
                    {% set real_p = os.path.realpath(out_file) %}
                    {% if '/printer_data/' not in real_p %}
                        { err('Image path outside allowed server files: ' ~ real_p) }
                    {% else %}
                        {% set rel = real_p.split('/printer_data/', 1)[1] %}
                        {% set html = img_click_open(
                            '/server/files/' ~ rel ~ '?t=' ~ (time.time()*1000)|int,
                            s.max_px,
                            'Motion Plot',
                            s.open_size_percent
                        ) %}
                        { msg('Graph generated:<br>' ~ html|replace('\n','')) }
                    {% endif %}
                {% endif %}
            {% endif %}
            SET_GCODE_VARIABLE MACRO={SELF} VARIABLE=started_at VALUE=-1
        {% endif %}
    {% endmacro %}


    # --- System Helpers ------------------------------------------------------
    {%- macro _resolve_python(path) -%}
        {%- set py = expand(path) -%}
        {%- if (not py) or (not os.path.exists(py)) -%}
            {%- set py = sys.executable if os.path.exists(sys.executable) else '/usr/bin/python3' -%}
        {%- endif -%}
        { py }
    {%- endmacro -%}

    {% macro _ensure_dir(path) %}
        {% if not os.path.exists(path) %}
            {% set _ = os.makedirs(path, 511, True) %}
            { dbg('Created directory: ' ~ path) }
        {% endif %}
    {% endmacro %}

    {%- macro _read_pid(path) -%}
        {%- if os.path.exists(path) -%}
            {%- set c = bi.open(path, 'r').read().strip().splitlines() -%}
            { (c[0] ~ '|' ~ c[1]) if c|length >= 2 else '' }
        {%- endif -%}
    {%- endmacro -%}

    {% macro _kill_process(pid_file) %}
        {% set pid_data = _read_pid(pid_file) %}
        {% if pid_data %}
            {% set pid = pid_data.split('|')[0]|int %}
            {% if pid > 0 %}
                {% set _ = os.kill(pid, signal.SIGINT) %}
                {% set _ = dbg('Sent SIGINT to PID ' ~ pid) if not 'KILL' in params %}
            {% endif %}
            {% set _ = os.remove(pid_file) if os.path.exists(pid_file) %}
        {% endif %}
    {% endmacro %}


    # --- UI Component --------------------------------------------------------
    {%- macro img_click_open(src, max_px=400, img_title='Click to open full-size', open_size_percent=75) -%}
        {%- set _, _ = vaargs, kwargs -%}
        {%- set zoom_factor = [[open_size_percent|int, 100]|min, 10]|max / 100.0 -%}
        {%- set sanitized_src_id = 'plot-container-' ~ src.split('?')[0]|replace('/','-')|replace('.','-')|replace(':','-') -%}
        {%- set out =
            '<div id="' ~ sanitized_src_id ~ '" data-zoom="' ~ zoom_factor ~ '" style="max-inline-size:' ~ max_px ~ 'px;inline-size:100%;cursor:zoom-in;">' ~
            '<div class="img_box" style="inline-size:100%;background:var(--p-background-darker);border-radius:4px;">' ~
            '<img data-main src="' ~ src ~ '" alt="' ~ img_title ~ '" draggable="false" ' ~
            'style="display:block;inline-size:100%;block-size:auto;object-fit:contain;" ' ~
            'onload="(function(i){i.style.aspectRatio=i.naturalWidth+\' / \'+i.naturalHeight;})(this)">' ~
            '</div>' ~
            '</div>' ~
            '<img src="x" style="display:none" data-container-id="' ~ sanitized_src_id ~ '" data-url="' ~ src.split('?')[0] ~ 
            '" onerror="(function(el){try{var box=document.getElementById(el.dataset.containerId);if(!box||box.dataset.init){el.remove();return;}box.dataset.init=\'1\';var url=el.dataset.url;var ph=box.querySelector(\'.plot-placeholder\');var img=box.querySelector(\'img[data-main]\');var tries=0,max=90;function fitScale(nw,nh,z){var w=window.innerWidth,h=window.innerHeight;var k=Math.min((w*z)/nw,(h*z)/nh);return k>0?k:1}function openOverlay(pic){var nw=pic.naturalWidth,nh=pic.naturalHeight;var ov=document.createElement(\'div\');ov.setAttribute(\'style\',\'position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:99999;cursor:zoom-out;overflow:hidden\');var panel=document.createElement(\'div\');panel.setAttribute(\'style\',\'position:absolute;left:0;top:0;transform-origin:0 0;cursor:auto\');var big=document.createElement(\'img\');big.draggable=false;big.src=pic.currentSrc||pic.src;big.setAttribute(\'style\',\'display:block;max-width:none;max-height:none;user-select:none;-webkit-user-drag:none\');panel.appendChild(big);ov.appendChild(panel);document.body.appendChild(ov);var z=parseFloat(box.dataset.zoom)||0.75;var k=fitScale(nw,nh,z),kmin=0.02,kmax=50,tx=Math.floor((window.innerWidth-nw*k)/2),ty=Math.floor((window.innerHeight-nh*k)/2);function apply(){panel.style.transform=\'translate(\'+tx+\'px,\'+ty+\'px) scale(\'+k+\')\';panel.style.width=nw+\'px\';panel.style.height=nh+\'px\';}apply();var drag=false,lx=0,ly=0;panel.addEventListener(\'mousedown\',function(e){if(e.button===0){drag=true;lx=e.clientX;ly=e.clientY;panel.style.cursor=\'grabbing\';e.preventDefault();}});window.addEventListener(\'mouseup\',function(){if(drag){drag=false;panel.style.cursor=\'auto\';}});window.addEventListener(\'mousemove\',function(e){if(!drag)return;var dx=e.clientX-lx,dy=e.clientY-ly;lx=e.clientX;ly=e.clientY;tx+=dx;ty+=dy;apply();});panel.addEventListener(\'wheel\',function(e){e.preventDefault();var r=panel.getBoundingClientRect();var mx=e.clientX,my=e.clientY;var u=(mx-r.left)/k,v=(my-r.top)/k;var step=e.ctrlKey?0.15:0.08;var f=e.deltaY<0?(1+step):(1-step);if(!(f>0))f=1;var k2=Math.min(Math.max(k*f,kmin),kmax);var tx2=Math.round(mx-u*k2),ty2=Math.round(my-v*k2);k=k2;tx=tx2;ty=ty2;apply();},{passive:false});function onRes(){var mx=window.innerWidth/2,my=window.innerHeight/2;var r=panel.getBoundingClientRect();var u=(mx-r.left)/k,v=(my-r.top)/k;var k2=fitScale(nw,nh,z);var tx2=Math.round(mx-u*k2),ty2=Math.round(my-v*k2);k=k2;tx=tx2;ty=ty2;apply();}function onKey(e){if(e&&e.key===\'Escape\')close();}function close(){window.removeEventListener(\'resize\',onRes);document.removeEventListener(\'keydown\',onKey);if(ov.parentNode)ov.parentNode.removeChild(ov);}ov.addEventListener(\'click\',function(){close();});panel.addEventListener(\'click\',function(e){e.stopPropagation();});window.addEventListener(\'resize\',onRes);document.addEventListener(\'keydown\',onKey);}function bindClick(){if(box.dataset.zoomReady)return;box.dataset.zoomReady=\'1\';box.addEventListener(\'click\',function(){var pic=box.querySelector(\'img[data-main]\');if(pic&&pic.complete&&pic.naturalWidth)openOverlay(pic);});}function poll(){tries++;var bust=Date.now();var probe=new Image();probe.onload=function(){img.src=url+\'?t=\'+bust;img.style.display=\'block\';if(ph)ph.style.display=\'none\';img.onload=function(){img.style.aspectRatio=img.naturalWidth+\' / \'+img.naturalHeight;};bindClick();};probe.onerror=function(){if(tries<max){setTimeout(poll,400+Math.min(tries*120,2000));}else{if(ph)ph.textContent=\'Failed to load plot.\';}};probe.src=url+\'?t=\'+bust;}poll();}catch(e){}finally{el.remove();}})(this)">' -%}
        { out|replace('\n','') }
    {%- endmacro -%}


    # --- Execution -----------------------------------------------------------
    {%- if 'START' in params -%}
        { do_start() }
    {%- elif 'STOP' in params -%}
        { do_stop() }
    {%- elif 'KILL' in params -%}
        { _kill_process(expand(s.pidfile)) }
    {%- else -%}
        { err('Usage: MOTION_LOGGER START | STOP') }
    {%- endif -%}


    # --- Debug Footer --------------------------------------------------------
    {% if _dbg_buf %}
        {% set block =
            '<details>' ~
                '<summary style="cursor:pointer; color:var(--v-accent-base); margin:6px 0 3px 0;">' ~
                    '<span class="text--primary">MOTION_LOGGER log</span>' ~
                '</summary>' ~
                '<blockquote class="accent--text text--lighten-1" ' ~
                            'style="display:inline-block; width:fit-content; max-width:90%;' ~
                                   'margin-top:0.6em; white-space:pre-wrap;' ~
                                   'overflow-wrap:anywhere; word-break:break-word;' ~
                                   'padding:0.5em 0.75em; border-left:3px solid currentColor;' ~
                                   'background:var(--p-background-darker, rgba(255,255,255,0.06)); line-height:1.25em; font-size:75%;">' ~
                    '<span class="text--primary">' ~ _dbg_buf|join('') ~ '</span>' ~
                '</blockquote>' ~
            '</details>'
        %}
        { action_respond_info(block|replace('\n','')) }
    {% endif %}


[delayed_gcode _ENSURE_MOTION_LOGGER_STOPPED]
initial_duration: 1
gcode:
    MOTION_LOGGER KILL=1



# Example use case (semi automated) with rounded_g0:
# [gcode_macro ROUNDED_G0]
# rename_existing: _ROUNDED_G0
# variable_duplicate_buffer: []
# gcode:
#     {% set _pos = printer.toolhead.position %}
#     {% set _ = duplicate_buffer.append({'X': _pos[0], 'Y': _pos[1], 'Z': _pos[2]}) if not duplicate_buffer %}
#     {% set _ = duplicate_buffer.append(params) if params %}
# 
#     {% set do_flush = params.D|d(0)|int == 0 and duplicate_buffer|length > 2 %}
#     {% set do_log = 'LOG' in params %}
# 
#     _ROUNDED_G0 {rawparams}
#     {% if do_flush and do_log %}
#         M400
#         MOTION_LOGGER STOP=1
#         { action_respond_info('ROUNDED_G0 flush:<br>' ~ duplicate_buffer|join('<br>')) }
#     {% elif 'LOG' in params %}
#         M400
#         MOTION_LOGGER START=1
#         G4 P1000
#     {% endif %}
#     {% set _ = duplicate_buffer.clear() if do_flush %}
#     SET_GCODE_VARIABLE MACRO=ROUNDED_G0 VARIABLE=duplicate_buffer VALUE="{duplicate_buffer}"
    
